<?xml version="1.0" encoding="UTF-8"?>
<modification>
<name>Admin Category Filter</name>
<code>admin_category_filter</code>
<version>2020.11.25</version>
<author>OSEC.tw</author>
<link>https://www.osec.tw</link>


<file path="admin/controller/catalog/category.php">
<operation  error="skip">
	<search><![CDATA[$url .= '&sort=' . $this->request->get['sort'];]]>
	</search>
	<add position="before"  offset="1"><![CDATA[
			if (isset($this->request->get['filter_name'])) {
				$url .= '&filter_name=' . urlencode(html_entity_decode($this->request->get['filter_name'], ENT_QUOTES, 'UTF-8'));
			}
	]]></add>
</operation>	
<operation  error="skip">
	<search><![CDATA[protected function getList() {]]>
	</search>
	<add position="after"><![CDATA[	
		if (isset($this->request->get['filter_name'])) 
		   {
		   $filter_name = $this->request->get['filter_name'];
		   } 
		   else 
		   {
			$filter_name = null;
		   }
		  $data['user_token'] = $this->session->data['user_token'];
	]]></add>
</operation>
<operation  error="skip">
	<search><![CDATA['order' => $order,]]></search>
	<add position="after"><![CDATA[	
		'filter_name' => $filter_name,
	]]></add>
</operation>
<operation  error="skip">
	<search><![CDATA[$data['order'] = $order;]]></search>
	<add position="after"><![CDATA[	
	    $data['filter_name'] = $filter_name;
	]]></add>
</operation>
<operation error="skip">
	<search><![CDATA[$category_total = $this->model_catalog_category->getTotalCategories();]]></search>
	<add position="replace">
		<![CDATA[$category_total = $this->model_catalog_category->getTotalCategories($filter_data);]]>
		</add>
</operation>
</file>

<file path="admin/model/catalog/category.php">		
<operation  error="skip">
	<search><![CDATA[$sql .= " AND cd2.name LIKE '%" . $this->db->escape($data['filter_name']) . "%'";]]>			
	</search>
	<add position="replace"><![CDATA[			    
			$filter =preg_replace('/[^A-Za-z0-9 \-]/', '', $this->request->get['filter_name']);
			$filter_array=explode("gt", $filter);
			$filter_name = end($filter_array);
			$sql .= " AND cd2.name LIKE '" . $this->db->escape($filter_name) . "%'";
	]]></add>
</operation>
<operation  error="skip">
	<search><![CDATA[$query = $this->db->query("SELECT COUNT(*) AS total FROM " . DB_PREFIX . "category");]]>			
	</search>
	<add position="replace"><![CDATA[			    
		if (!empty($this->request->get['filter_name'])) {
			$filter_n =preg_replace('/[^A-Za-z0-9 \-]/', '', $this->request->get['filter_name']);
			$filter_name_array=explode("gt", $filter_n);
			$filter_name = end($filter_name_array);
			$sql = "SELECT COUNT(*) AS total FROM " . DB_PREFIX . "category cp LEFT JOIN " . DB_PREFIX . "category_description cd2 ON (cp.category_id = cd2.category_id) WHERE cd2.name LIKE '" . $this->db->escape($filter_name) . "%'";
		} else {
			$sql = "SELECT COUNT(*) AS total FROM " . DB_PREFIX . "category";
		}
		$query = $this->db->query($sql);
	]]></add>
</operation>
</file>

<file path="admin/view/template/catalog/category_list.twig">
<operation  error="skip">
	<search><![CDATA[<thead>]]></search>
	<add position="after" ><![CDATA[
							<tr>
								<td colspan="4">
								 <input type="text"  style="width: 36%; display: inline-block;" name="filter_name" value="{{ filter_name }}"  id="input-name" class="form-control" />
								 <button type="button" id="button-filter" class="btn btn-primary button" style="margin-top: -4px;" ><i class="fa fa-filter"></i> {{button_filter}}</button>
								 <button type="button" id="button-clear" style="margin-top: -4px;" class="btn btn-danger button">{{button_clear}}</button>
							   </td>
                            </tr>
	]]></add>
</operation>	
<operation  error="skip">
<search><![CDATA[{{ footer }}]]></search>
	<add position="before"><![CDATA[
<script type="text/javascript"><!--
$('#button-filter').on('click', function() {
	var url = 'index.php?route=catalog/category&user_token={{ user_token }}';

	var filter_name = $('input[name=\'filter_name\']').val();
		
	if (filter_name) 
	{
		url += '&filter_name=' + encodeURIComponent(filter_name);
	}
	location = url;
});

$('#button-clear').on('click', function() {
	location ='index.php?route=catalog/category&user_token={{ user_token }}';
});

// Category
$('input[name=\'filter_name\']').autocomplete({
  'source': function(request, response) {
    $.ajax({
      url: 'index.php?route=catalog/category/autocomplete&user_token={{ user_token }}&filter_name=' +  encodeURIComponent(request),
      dataType: 'json',
      success: function(json) {
	    response($.map(json, function(item) {
          return {
            label: item['name'],
            value: item['category_id']
          }
        }));
      }
    });
  },
  'select': function(item) {
    $('input[name=\'filter_name\']').val(item['label']);
  }
});		
//--></script>
	]]></add>
</operation>
</file>
</modification>